# ТЗ на станции

С точки зрения железа станции должны быть двух типов:

1.	"автономные" - без Bluetooth
2.	"судейские" - с Bluetooth и увеличенным объемом памяти

Автономные станции ставятся на КП, судейские - на все обитаемые точки. На финишах использование судейских станций обязательно, на остальных обитаемых точках желательно. На необитаемые КП судейские станции вешать можно, но не нужно.

С точки зрения софта станции могут находиться в одном из трех режимов:

1.	Режим инициализации чипов (только "судейские" станции)
2.	Режим работы финишным КП (только "судейские" станции)
3.	Режим работы любым КП, кроме финишного

Переключение между режимами может производиться по Bluetooth и с помощью мастер-чипа.

## Взаимодействие с чипами

### 1.	В режиме инициализации.

Станция ждет, когда на нее положат чип, а затем ждет данных от приложения на планшете. Приложение передает данные на станцию и та, в случае наличия чипа, работает с ним, иначе сигнализирует ошибку. Станция считывает из чипа UID и время предыдущей инициализации. Если оно было менее недели назад, чип не является мастер-чипом и на нем есть отметки на станциях, то инициализация не происходит и станция сигнализирует об ошибке (чтобы случайно не затереть чип, которым уже начала пользоваться команда). Если все ок, то новые данные записываются в чип. Все предыдущие отметки на станциях стираются.

В чип участников пишется:
- номер команды
- время инициализации
- битовая маска участников

В мастер-чип пишется та инструкция, которая должна будет потом исполняться с помощью этого мастер-чипа.

### 2.	В режиме КП

Станция читает из чипа номер команды, номер марш-броска, битовую маску участников.
Если в чипе ничего этого нет, а это мастер-чип, то выполняется инструкция из мастер-чипа.
Если номер станции равен нулю, то станция сигнализирует об ошибке (считаем, что это станция без присвоенного номера, которая не должна работать с чипами участников)

Если время инициализации чипа отличается от текущего времени станции более, чем на неделю, то станция сигнализирует об ошибке и больше ничего не делает.

Если станция судейская, а номер последнего взятого КП не совпадает с номером станции, то станция также копирует себе в память все данные с чипа (список взятых КП и времена на этих КП).

Если битовая маска участников для команды с данным номером, хранящаяся в станции (полученная ранее по Bluetooth), не совпадает с этими данными в чипе, то станция записывает их из станции в чип и не записывает в чип факт посещения КП (так как в этот раз чип поднесли, чтобы обновить в нем битовую маску).

В режиме финишного КП: Если битовая маска в станции совпадает с маской в чипе или же маска для данной команды в памяти станции станции отсутствует, то станция регистрирует посещение КП. Для этого она записывает в конец списка в чипе свой номер и время, а также записывает себе в память в конец списка команд, взявших этот КП, номер команды и время.

В режиме обычного КП: Если битовая маска в станции совпадает с маской в чипе или же маска для данной команды в станции станции отсутствует, то станция сравнивает номер последнего взятого КП со своим номером. Если они совпадают (попытка повторной отметки на станции), то ничего не происходит. Если они отличаются, то станция регистрирует посещение КП. Для этого она записывает в конец списка в чипе свой номер и время, а также записывает себе в память в конец списка команд, взявших этот КП, номер команды и время.

***

# ТЗ на взаимодействие с приложением (API)

Станция выступает в роли Bluetooth-сервера, приложение на планшете - в роли клиента. Приложение может делать поиск всех доступных на данный момент станций, подключаться к одной станции, давать им команды и ожидать ответа. Каждая станция должна иметь в Bluetooth уникальное имя, состоящее из "Sportiduino-" и серийного номера станции (задаваемого при его производстве).

Ответ станции приложение ждет не более 1 секунды, если он не получен, то приложение считает, что связь со станцией потеряна и вызов закончился ошибкой.

## 1. Универсальные функции для всех режимов

### SetMode
вход: номер нового режима, в который должна перейти станция : byte, номер станции : byte

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции : dword

примечание: если номер станции, указанный при вызове функции, не совпадает с текущим номером станции, то возвращать ошибку - для смены номера станции используем функцию ResetStation

### SetTime
вход: время с планшета (скорее всего это будет UTC+3) : dword

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции : dword

### ResetStation
вход: новый номер станции : byte, старый номер станции : byte, количество отметок чипов, которое должно быть на данной станции, : word, время последней отметки на данной станции : dword

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции : dword

примечание: возможность смены номера станции и стирания всех данных в ней нужна как минимум для подготовки станции к новому ММБ, но надо обезопаситься от случайного стирания данных в станции, поэтому при вызове этой функции мы сообщаем станции информацию о том, какие данные мы уже считали из станции, чтобы она могла спокойно все удалить, если новых данных не появилось.

примечание: перед тем, как перевести станцию в режим инициализации, приложение будет менять ее номер на 0, чтобы потом при использовании этой станции на другой активной точке требовалось в явном виде задать ее новый правильный номер.

## 2. Режим инициализации

### GetStatus
вход: отсутствует

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции : dword, номер режима (2 или 3) : byte, номер станции : byte, количество отметок чипов на данной станции : word, время последней отметки на данной станции : dword

### InitChip
вход: номер команды (для мастер-чипа это 0xffff, далее для мастер-чипа следуют инструкции, которые в него надо записать [AZ Саша В., какой точный формат данных для мастер-чипа?]) : word, тип чипа [AZ Саша В., что сюда надо писать?] : word, время инициализации : dword, номер ммб : word, битовая маска явившихся на старт участников : word, 0x00000000 (reserved) : dword

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции в момент инициализации чипа : dword, UID инициализированного чипа : dword

## 3. Оба режима работы как КП

### GetStatus
вход: отсутствует

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции : dword, номер режима (2 или 3) : byte, номер станции : byte, количество отметок чипов на данной станции : word, время последней отметки на данной станции : dword

### GetLastTeams
вход: отсутствует

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции : dword, массив из пар "информация о чипе : четыре dword, см. InitChip" - "время отметки : dword"

примечание: планшет будет раз в секунду опрашивать станцию этой функцией, чтобы сразу показать на экране только что отметившуюся команду и позволить судье ввести сходы участников
//AV Упростил эту функцию, на запрос будет выдаваться только последняя выполненная отметка

### GetChipsHistory
вход: время (возвращать только те данные, которые были считаны из чипов после этого времени) : dword

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции : dword, [AZ Саша В., напиши, в каком виде тебе удобнее сообщать данные с чипов о посещении других станций, чтобы тебе делать меньше манипуляций с данными при их отдаче]

примечание: функция для копирования в приложение всех данных с чипов (о посещении других станций), прошедших через данную станцию

### UpdateTeamMask
вход: номер команды: word, новая битовая маска участников: word

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции : dword

### GetStationClones
вход: отсутствует

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции : dword, все данные с обычной станций без Bluetooth, склонированные на нашу станцию с помощью мастер-чипов

### WriteMasterChip
вход: Тип мастер чипа: byte, год-2000: byte, месяц: byte, день: byte, час: byte, минута: byte, секунда: byte, новый номер станции: byte, новый пароль :3 x byte, старый пароль 3 x byte, настройки станции: byte,

выход: код выполнения команды (0 - успех, >0 - код ошибки) : byte, время на станции


## Передача в обе стороны с помощью 32-байтных пакетов со следующей структурой:

||Значение|Адрес байта в пакете|
|---|---|---|
|Старт|0xFE|0|
|Старт|0xFE|1|
|Старт|0xFE|2|
|Старт|0xFE|3|
|Номер команды||4|
|Если пакет не последний - 128,
Если пакет последний – число байт данных||5|
|данные (25 байт)||	6-30|
|финиш|0|31|

## Номера соответствующих команд

запрос	Номер команды	данные (номер байтов в массиве данных)

### бт-->станция

SetMode	0x80	номер режима(0),номер станции(1)

SetTime	0x81	год-2000(0) месяц(1) день(2) час(3) минута(4) cекнуда(5) (UTC)

ResetStation	0x82	новый номер станции(0), старый номер станции(1), количество отметок чипов, которое должно быть на данной станции (2-3), время последней отметки на данной станции (4-7)

GetStatus	0x83

InitChip	0x84	номер чипа (0-1), текущее время (2-5), информация в 6-7 страницы (6-13)

GetLastTeam	0x85

GetChipHistory	0x86	время после которого возвращать считанные с чипов данные (0-3)

GetStationClones	0x87

UpdateTeamMask	0x88	номер команды (0-1), новая битовая маска (2-9)

WriteMasterChip	0x89	Тип мастер чипа (0), год-2000 (1), месяц (2), день (3), час (4), минута (5), секунда (6), новый номер станции(7), новый пароль (8-10),старый пароль (11-13), настройки станции (14)

### ответ станции

SetMode	0x90	код выполнения команды(0), время на станции (1-4)

SetTime	0x91	код выполнения команды(0), время на станции (1-4)

ResetStation	0x92	код выполнения команды(0), время на станции (1-4)

GetStatus	0x93	код выполнения команды(0), время на станции (1-4), номер режима (5),  количество отметок на станции (6-7), время последней отметки на станции (8-11)

InitChip	0x94	код выполнения команды(0), время на станции (1-4), UID чипа (5-11)

GetLastTeams	0x95	код выполнения команды(0), время на станции (1-4), номер чипа (5-6), время инициализации (7-10), информация из страниц 6-7(11-18), время отметки на станции (19-22)

GetChipHistory	0x96	код выполнения команды(0), время на станции (1-4), номер чипа(5-6), информация в 6-7 страницах (7-14), номер станции(15), время отметки (16-19),номер станции2(20),время отметки (21-24), номер станции3(0),…

GetStationClones	0x97	код выполнения команды(0), время на станции (1-4), номер станции с которой сняли лог (5) номер чипа1 (6-7), номера чипа2 (8-9)....

UpdateTeamMask	0x98	код выполнения команды(0), время на станции (1-4)

WriteMasterChip	0x99	код выполнения команды(0), время на станции (1-4)

Ответ на команды GetChipHistory и GetStantionClones будет передаваться последовательно по отдельным командам (до 25 пакетов данных на одну команду) с перерывами на пустой или незаконченных пакет.

### коды выполнения команд:

0 - ОК

1 - Неправильный номер станции при функциях SetMode, resetStation

2 - Ошибка чтения чипа

3 - Ошибка записи чипа

4 - Чип инициализирован меньше чем неделю назад при команде initChip

5 - Неправильный номер чипа при команде UpdateTeamMask

6 - Нет чипа на станции


### Номера режимов при SetMode:

0 - режим инициализации

1 - режим КП (~~как обычного так и финишного. Финишный КП определяется номером станции - 245~~). (Ошибка! Режим финишного КП - отдельный режим 2)

### Хранение данных в памяти станции

После стирания, во всех байтах флэш памяти будет 255.
Записать данные можно только в байты после очистки, перезаписать поверх данных без стирания не получится.

Каждому номеру отведёно 1000 байт памяти по адресу: номер x 1000 + 100000,
туда скачиваются все сырые данные с чипа во время отметки в формате:

байты страницы 0 (0-3), байты страницы 1 (4-7), байты страницы 2 (8-11), ...

Если страницы в чипе пустая (кроме первых 8-ми), то в памяти флэша останется 255.

При повторном считывании битовая маска не будет перезаписываться.

Также первичная информация о чипе записываается в память по адресу номер x 20:

номер чипа(0-1), время инициализации (2-5), инфоблоки(6-13), время отметки на станции(14-17)

## [Настройка станции](НастройкаСтанциии.docx)

## [Схема станции](../hardware/)

***

# Порядок работы судей

## 1. Стартовые коридоры

1. Без диапазонов номеров. Участник подходит к любому судье говорит ему номер. [AT Может разграничивать коридоры по цвету выдаваемых чипов? AZ Можно, но участники могут неправильно выбрать коридор, если их, скажем, заявлено 2, а на старт пришел 1]
2. Судья вводит номер в планшет. Планшет ему отображает: номер команды, название команды, список участников, число карт
3. Судья озвучивает название команды, спрашивает у участников все ли пришли на старт.
4. Если не все, выясняет кто не пришёл, отмечает их в планшете.
5. Судья берёт чип соответствующего цвета (1 участник, 2 участников, много участников), кладет их на судейскую станцию
6. Нажимает "инициализировать чип".
7. После сигнала со станции отдаёт чип участнику.
8. Второй судья после пункта 2 взимает с участника стартовый взнос.

## 2. Старт

1. Участник подходит к судье на старте.
2. Производит отметку на стартовой станции. (Если станция будет судейской, то судья сможет увидеть число карт на команду на планшете).[AT Но можно без этого обойтись. Тираж печатается с запасом.]
3. Участник берёт нужное число карт у уходит.

## 3. ОКП, пункты проверки целостности команды.

1. Два коридора: "Зеленый" для участников-одиночек и двоек в полном составе, "Красный" для больших команд и команд с сошедшими участниками.
2. В "Зеленом" коридоре станция производит отметку в чип, на планшете показывается состав команды. Если он соответствует фактическому количеству людей перед судьей, то команда отпускается. Если не соответствует, то действия как в "Красном" коридоре.
3. В "Красном" коридоре станция производит отметку в чип, на планшете показывается состав команды. Если он соответствует фактическому количеству людей перед судьей, то команда отпускается. Если не соответствует, то судья выясняет, кто сошел, отмечает его в планшете и просит команду повторно поднести чип к станции, станция записывает в чип измененный состав команды и на следующих точках отмечать сход вручную уже не нужно.
4. Участник потерял чип. Варианты:
 а. Всё тоже что и на стартовом коридоре (пункты 1-7). Но номер = номер + 2000.
 б. Судья достает уже инициализированный чип под заданное число участников с номерами 2000+. Делает отметку в протоколе особых случаев.
 в. Всё тоже что и на стартовом коридоре (пункты 1-7). И номер = номер потерянного чипа.

## 4. Смена карт

Аналогично ОКП + выдача карт.

## 5. Промфиниш

Аналогично ОКП + если отсутствующий участник не сошел, а отстал, то судья просит команду дождаться его и повторно приложить чип. Если команда игнорирует просьбу и уходит - записываем в протокол особых случаев.

## 6. Промстарт

Аналогично ОКП + выдача карт

## 7. Финиш

Аналогично ОКП + если отсутствующий участник не сошел, а отстал, то судья просит команду дождаться его и повторно приложить чип. Если команда игнорирует просьбу и уходит - записываем в протокол особых случаев.
Чип забираем. [AT некоторое количество чипов останется у сошедших - организуем их сбор где-то (в Белом листе?) или просто списываем через некоторое время. И постоянно надо будет дозакупать чипы взамен выбывших]

***

# Прошивка станции отметки

1.	Станция должна писать в чип отметку - номер станции и время
2.	Сохранять во внутреннюю память номер и время отметки команды
3.	Станции работают в двух режимах - с возможностью повторной отметки и без
4.	Станция старта не реагирует на чип, если он не пустой [AZ не нужно - это потребует ввода еще одного типа станций - "стартовые"]
5.	Обычная станция не реагирует на чип, если он без старта [AZ не нужно - это потребует ввода еще одного типа станций - "стартовые"]
6.	Обычная станция не реагирует на чип, если он с финишем [AZ не нужно, станции ничего не требуется знать про другие станции, отметки после финиша можно выловить в базе на сайте]
7.	Номер и время станции можно изменить с помощью мастер-чипа с паролем
8.	С помощью специальных чипов можно скачать данные по отметкам со станции
9.	Станцию можно вогнать в режим сна с помощью специального мастер-чипа с паролем и разбудить с помощью любого чипа
10.	На станцию можно передать пароль и настройки с помощью специального чипа

# Прошивка судейских станций

1.	При отсутствии подключения по БТ, станция становится станцией отметки.
2.	При поднесении чипа к станции происходит его полное считывание и передача данных по БТ на планшет. В том числе, передается уникальный номер чипа, чтобы контролировать ситуацию в случае ошибочной выдачи одного и того же номера двум командам (также прозвучало предложение использовать для этого набор времён отметки).
3.	При получении команды с планшета, проводит очистку-проверку и инициализацию чипа (это нужно не только на столах регистрации перед стартом первого этапа, но и при выдаче дубликата взамен потерянного чипа).
4.	При получении команды с планшета записывает на чип обновленную маску наличия участников команды.
5.	При получении команды записи мастер-чипов, записывает их.
6.	Если станция настроена на точку типа "финиш" (промфиниш, финиш), то она работает в режиме с возможностью повторной отметки. В протокол на сайте попадает последняя отметка.

# Программа на планшет

1.	Импорт общих настроек для старта
2.	При вводе номера команды выводить данные о команде (название, участники, число карт)
3.	Передача команды инициализации чипа (номер команды, участники команды побитово). Должна ругаться при попытке записать номер, если команда с таким номером уже ушла.
4.	Принятие данных с судейской станции, при этом отображать на экран данные с базы: номер команды, участников и сохранять лог. Возможность посмотреть список взятых кп.
5.	После отображения команды иметь возможность назначать кому-то сход и/или отправить команду записать чип и биты участников.
6.	Запись мастер-чипов (корректировка времени, номера станции, настроек станции, дампа станции)
7.	Считывание дампов с мастер чипов (подумать над форматом)
8.	Возможность поиска номера команды по фамилии (если участник забыл номер).
9.	Возможность просмотреть взятые КП или обработать некую "программу" условий взятия - отображать выполнение условия "зеленым" невыполнение "красным", чтобы не считать вручную условия.
10.	Возможность ввести взятие КП вручную(на точках СК-ПФ-ФИНИШ, возможно на ОКП) по записям\фото шифра станций от участника. [AZ лучше в первой версии программы этот функционал не делать и редактировать данные на сайте]

***

# Расходы

Желательно знать, сколько будет потрачено на всё для возможной коррекции стартового взноса. Пока озвучивалась сумма в пределах 50р на одного участника.

# Генеральное тестирование

Организуются небольшие соревнования по ориентированию (или тестирование привязывается к одному из стартов Жени Батуева/Детей болот/МГУ). Под это на тестовой базе (или на сайте-клоне) создаётся "марш-бросок" со всем, чем надо: с дистанцией, заявкой участников и т.д. И отрабатываются все стадии, включая обработку данных и публикацию результатов.

# Планы на дальнейшие разработки

1.	Один участник - один чип, неснимаемые браслеты (как принято на всех рогейнах).
2.	Обработка данных со станций (как резервной копии, с возможностью взять данные оттуда, если данные с чипа будут потеряны).
